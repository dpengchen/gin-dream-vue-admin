<script setup lang="ts">
import LayoutContainer from '@/components/layout/LayoutContainer.vue'
import { onMounted, reactive, ref } from 'vue'
import {
  ExportOutlined,
  PlusOutlined,
  ReloadOutlined,
  DeleteOutlined,
  EditOutlined,
  SearchOutlined,
} from '@ant-design/icons-vue'
import type { SysUser, SysUserQuery } from '@/interface/system/sys_user'
import { message, Modal } from 'ant-design-vue'
import {
  addSysUser,
  exportSysUser,
  getSysUserById,
  getSysUserList,
  modifySysUser,
  removeSysUserById,
} from '@/api/system/sys_user'
import type { PageResult } from '@/interface/core'
import dayjs from 'dayjs'

const sysUserRef = ref()
const sysUserForm = reactive({
  form: {} as SysUser, //表单数据
  rules: {
    
    //用户名
    username: [{ required: true, message: '用户名不能为空', trigger: 'blur' }],

  }, //校验规则
  visible: false, //drawer 抽屉显示
  title: '新增系统用户', //标题
  reset: () => {
    //重置表单
    sysUserForm.form = {
      id: null,
      
      //用户名
      username: null,
      //密码
      password: null,
      //昵称
      nickname: null,
      
    } as SysUser
  },
  edit: (record: any) => {
    //新增、修改
    if (record.id) {
      getSysUserById(record.id).then((resp: any) => {
        sysUserForm.form = resp.data
      })
      //修改
      sysUserForm.title = '修改系统用户'
      sysUserForm.visible = true
      return
    }
    sysUserForm.reset()
    sysUserForm.title = '新增系统用户'
    sysUserForm.visible = true
  },
  confirm: () => {
    //确认保存或者新建
    sysUserRef.value.validate().then(() => {
      if (sysUserForm.form.id) {
        //修改
        modifySysUser(sysUserForm.form, sysUserForm.form.id).then((resp: any) => {
          message.success(resp.msg)
          sysUserForm.visible = false
          table.load()
        })
        return
      }

      //新建
      addSysUser(sysUserForm.form).then((resp: any) => {
        message.success(resp.msg)
        sysUserForm.visible = false
        table.load()
      })
    })
  },
  remove: (record: SysUser) => {
    let ids: number[] | string[] = []
    if (!record.id) {
      ids = table.selectedRowKeys
    } else {
      ids = [record.id]
    }
    Modal.confirm({
      title: `确定要删除该ID为${JSON.stringify(ids)}系统用户吗？`,
      centered: true,
      cancelText: '取消',
      okText: '确认',
      onOk: () => {
        removeSysUserById(ids).then((resp: any) => {
          message.success(resp.msg)
          table.load()
        })
      },
    })
  },
})
const table = reactive({
  list: [] as SysUser[],
  total: 0,
  loading: true,
  params: {
    
    //用户名
    username: null,
    //昵称
    nickname: null,

    page: 1,
    size: 10,
  } as SysUserQuery,
  visible: true,
  selectedRowKeys: [] as string[] | number[],
  load: () => {
    //加载
    table.loading = true
    getSysUserList(table.params).then((resp: any) => {
      const data = resp.data as PageResult<SysUser>
      table.list = data.list
      table.total = data.total
      table.loading = false
    })
  },
  reset: () => {
    table.params = {
      
      //用户名
      username: null,
      //昵称
      nickname: null,

      page: 1,
      size: 10,
    } as SysUserQuery
    table.load()
  },
  select: (selectedRowKeys: string[] | number[]) => {
    //选择
    console.log(selectedRowKeys)
    table.selectedRowKeys = selectedRowKeys
    console.log('table.selectedRowKeys', table.selectedRowKeys)
  },
  export: () => {
    //导出
    let title = `确定将搜索条件结果共[${table.total}]条数据全部导出吗？`
    if (table.selectedRowKeys.length) {
      title = `确定将选中数据${JSON.stringify(table.selectedRowKeys)}导出吗`
    }

    Modal.confirm({
      title: title,
      okText: '确认',
      cancelText: '取消',
      onOk: () => {
        exportSysUser(table.params, table.selectedRowKeys).then(() => {})
      },
    })
  },
  columns: [
    {
      title: 'ID',
      dataIndex: 'id',
      key: 'id',
      width: 50,
    },

    
    {
      title: '用户名',
      dataIndex: 'username',
      key: 'username',
      width: 180,
    },
    {
      title: '密码',
      dataIndex: 'password',
      key: 'password',
      width: 180,
    },
    {
      title: '昵称',
      dataIndex: 'nickname',
      key: 'nickname',
      width: 180,
    },

    {
      title: '创建时间',
      dataIndex: 'createTime',
      key: 'createTime',
      width: 180,
    },
    {
      title: '更新时间',
      dataIndex: 'updateTime',
      key: 'updateTime',
      width: 180,
    },
    {
      title: '创建人',
      dataIndex: 'createByNickname',
      key: 'createByNickname',
      width: 150,
    },
    {
      title: '更新人',
      dataIndex: 'updateByNickname',
      key: 'updateByNickname',
      width: 150,
    },
    {
      title: '操作',
      dataIndex: 'operation',
      key: 'operation',
      width: 200,
      scopedSlots: { customRender: 'bodyCell' },
      fixed: 'right',
    },
  ],
})

onMounted(() => {
  //加载列表
  table.load()
})
</script>

<template>
  <div>
    <!--  搜索区域  -->
    <LayoutContainer v-if="table.visible" class="">
      <a-form :label-col="{ style: { width: '120px' } }">
        <a-row class="pt-3">
          
          <a-col :span="6">
            <a-form-item label="用户名">
              <a-input v-model:value="table.params.username"></a-input>
            </a-form-item>
          </a-col>
          
          <a-col :span="6">
            <a-form-item label="昵称">
              <a-input v-model:value="table.params.nickname"></a-input>
            </a-form-item>
          </a-col>
           
          <a-col span="6">
            <a-space class="ml-4">
              <a-button @click="table.load">
                <template #icon>
                  <SearchOutlined />
                </template>
                搜索
              </a-button>
              <a-button @click="table.reset">
                <template #icon>
                  <ReloadOutlined />
                </template>
                重置
              </a-button>
            </a-space>
          </a-col>
        </a-row>
      </a-form>
    </LayoutContainer>

    <!--  table区域 -->
    <LayoutContainer show-title>
      <template #right>
        <a-space class="mb-1">
          <a-button @click="sysUserForm.edit">
            <template #icon>
              <PlusOutlined />
            </template>
            新增系统用户
          </a-button>
          <a-button @click="sysUserForm.remove" :disabled="!table.selectedRowKeys.length">
            <template #icon>
              <DeleteOutlined />
            </template>
            删除系统用户
          </a-button>
          <a-button @click="table.export">
            <template #icon>
              <ExportOutlined />
            </template>
            导出
          </a-button>
          <a-button @click="table.visible = !table.visible">
            <template #icon>
              <SearchOutlined />
            </template>
            搜索
          </a-button>
          <a-button @click="table.load">
            <template #icon>
              <ReloadOutlined />
            </template>
            刷新
          </a-button>
        </a-space>
      </template>
      <!--      <a-table :columns="table.columns" :data-source="table.list" :scroll="{ x: 2000 }">-->
      <a-table
        :columns="table.columns"
        :data-source="table.list"
        :loading="table.loading"
        :pagination="false"
        :row-selection="{ selectedRowKeys: table.selectedRowKeys, onChange: table.select }"
        row-key="id"
        :scroll="{ x: true }"
      >
        <template #bodyCell="{ record, column }">
          <template v-if="['createTime', 'updateTime'].includes(column.key)">
            {{
              record[column.key]
                ? dayjs(new Date(record[column.key])).format('YYYY-MM-DD HH:mm:ss')
                : '无'
            }}
          </template>
          <template v-if="column.key === 'operation'">
            <a-space>
              <a-button @click="sysUserForm.edit(record)" type="link">
                <template #icon>
                  <EditOutlined />
                </template>
                修改
              </a-button>
              <a-button @click="sysUserForm.remove(record)" type="link">
                <DeleteOutlined />
                删除
              </a-button>
            </a-space>
          </template>
        </template>
      </a-table>
      <div class="mt-4 flex justify-end none">
        <a-pagination
          v-model:current="table.params.page"
          v-model:page-size="table.params.size"
          show-quick-jumper
          :total="table.total"
          @change="table.load"
        />
      </div>
    </LayoutContainer>
    <a-drawer
      :title="sysUserForm.title"
      :close-icon="null"
      v-model:open="sysUserForm.visible"
      width="800"
    >
      <template #extra>
        <a-space>
          <a-button @click="sysUserForm.visible = false">取消</a-button>
          <a-button type="primary" @click="sysUserForm.confirm">确认</a-button>
        </a-space>
      </template>
      <a-form
        ref="sysUserRef"
        :model="sysUserForm.form"
        :rules="sysUserForm.rules"
        :label-col="{ style: { width: '100px' } }"
      >
        <a-row>
          
          
          <a-col :span="12">
            <a-form-item label="用户名" name="username">
              <a-input v-model:value="sysUserForm.form.username" placeholder="请输入用户名" />
            </a-form-item>
          </a-col>
          
          <a-col :span="12">
            <a-form-item label="昵称" name="nickname">
              <a-input v-model:value="sysUserForm.form.nickname" placeholder="请输入昵称" />
            </a-form-item>
          </a-col>
           
        </a-row>
      </a-form>
    </a-drawer>
  </div>
</template>

<style scoped lang="scss"></style>
